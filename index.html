<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>套表 欄位定位</title>
		<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.20.custom.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" media="screen" href="css/ui-lightness/jquery-ui-1.8.20.custom.css" />
<!-- 		<link rel="stylesheet" type="text/css" media="screen" href="css/cupertino/jquery-ui-1.8.20.custom.css" /> -->
        <link rel="stylesheet" type="text/css" media="screen" href="css/ui.jqgrid.css" />
		<style type="text/css">
		    .ui-jqgrid {font-size:1em}

            /* 表格標題列高 */
		    .ui-jqgrid .ui-jqgrid-htable th div {
			    height:auto;
			    overflow:hidden;
			    padding-right:4px;
			    padding-top:2px;
			    position:relative;
			    vertical-align:text-top;
			    white-space:normal !important;
			}

			#formArea {  
			    background:#333;  
			    border: 1px solid #000;  
			    height:554px;  
			    margin:30px auto auto auto;  
			    position:relative;  
			    width:785px;
			    background-image: url('images/LLDLN085.gif');
                background-repeat: no-repeat;
			}  

			#formArea > div.ui-selecting {
			    background: #68BADA !important;
			    border:3px solid #000000 !important;
			    color: #000000 !important;
			}
			#formArea > div.ui-selected {
			    background: #68BADA !important;
			    border:3px solid #000000 !important;
                color: #000000 !important;
			}
			#formArea div.fvField,div.fvSubField {
			    position: absolute;
			    height: 19px;
			    border: 3px solid #68BADA;
			    cursor:move;
			}
			.fv-opacity{
		        filter:alpha(opacity=80);
                opacity: .8;
                -moz-opacity: .8;				
			}
			#formArea div p{
				cursor:move;
			}
			#formArea .ui-draggable{
			    /* color reference: http://craigsworks.com/projects/qtip/ 	*/
			    /*background-color: #F79992; /* red */
			    /*border: 3px solid #CE6F6F; /* red */
                /*color: #9C2F2F;            /* red */

			    /*background-color: #A2D959; /* green */
			    /*border: 3px solid #8FD401; /* green */
                /*color: #58792E;            /* green */

                background-color: #90D8F0; /* blue */
			    border: 3px solid #68BADA; /* blue */
                color: #155F8F;            /* blue */

			}
			#formArea .ui-draggable-dragging{
			    /* background-color:#91B168; */
			    background-color: #68BADa;
			    border: 3px dashed #000000;
			    color: #ffffff;            
			}

			span.ui-icon-circle-triangle-e, .ui-icon-circle-triangle-s, .ui-icon-plusthick, .ui-icon-minusthick{
                cursor: pointer;
			}

			div.configuring{
				float:left;
				margin-left: 0 px;
				margin-top: 3 px;
				padding: 10px 10px 10px 10px;
				color: #FFFFFF !important;
                background-color: #000000;
                height: 90px !important;
                width: 150px !important ;
                font-size: 0.8em;
			}

            .ui-button{
            	font-size: 0.8em;
            	width: 90px;
            	height: 30px;
            }
		</style>

		<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="js/jquery.backgroundpos.min.js"></script>		
		<script type="text/javascript" src="js/jquery-ui-1.8.20.custom.min.js"></script>
		<script src="js/i18n/grid.locale-tw.js" type="text/javascript"></script>
		<script src="js/jquery.jqGrid.min.js" type="text/javascript"></script>		
	</head>
	<body>
		<table>
		  <tr>
		  	<td>
			    <button id="initButton">初始定位</button>
			    <button id="cleanButton">清除定位</button>
			    <button id="finishButton">完成定位</button>
			    <button id="previewButton">報表預覽</button>
		  	</td>
		    <td>
		     	<div class="" id="status"></div>
		  	</td>
		  </tr>	
		  <tr>
			<td>
			    <table id="list"><tbody></tbody></table>
			</td>
			<td>
                <div class="form-image"></div>
        		<div id="formArea"></div>
			</td>
		  </tr>
		</table> 
	  
		<script type="text/javascript">
			$(document).ready(function() {
				var configClosed = "ui-icon-circle-triangle-e";
				var configOpened = "ui-icon-circle-triangle-s";
                var columnPlus = "ui-icon-plusthick";
                var columnMinus = "ui-icon-minusthick";

				var selected = $([]), offset = {top:0, left:0};

				//// Retrieve the object from storage (HTML 5)
			    var fields;
			    try {
			        fields = localStorage.getItem('_FormViewer.fields');
			    }
			    catch (err) {
			    	console.log("fail to call localStorage.getItem()");
                }

                if(!fields){
                	alert("Use Default Fields");
                	fields = [         	
						{id:"1", fkey:"fsign", fname:"簽名"    , ftype:"單一", flocation:"", fwidth: "100", ftalign: "置左", fstatus:"未設定"},
						{id:"2", fkey:"fproduct", fname:"科目"    , ftype:"多重", flocation:"", fwidth: "110", ftalign: "置中", fstatus:"未設定"},
						{id:"3", fkey:"fsummary", fname:"摘要"    , ftype:"多重", flocation:"", fwidth: "120", ftalign: "置右", fstatus:"未設定"},
						{id:"4", fkey:"fcost", fname:"金額"    , ftype:"多重", flocation:"", fwidth: "130", ftalign: "置左", fstatus:"未設定"},
						{id:"5", fkey:"ffcur", fname:"放款幣別", ftype:"單一", flocation:"", fwidth: "140", ftalign: "置中", fstatus:"未設定"},
						{id:"6", fkey:"fexrate", fname:"匯率"    , ftype:"單一", flocation:"", fwidth: "150", ftalign: "置右", fstatus:"未設定"},
						{id:"7", fkey:"frcur", fname:"還款幣別", ftype:"單一", flocation:"", fwidth: "160", ftalign: "置左", fstatus:"未設定"},
						{id:"8", fkey:"facc", fname:"扣款帳號", ftype:"單一", flocation:"", fwidth: "170", ftalign: "置中", fstatus:"未設定"},
						{id:"9", fkey:"ftotal", fname:"總金額"  , ftype:"單一", flocation:"", fwidth: "180", ftalign: "置右", fstatus:"未設定"}
			        ]; 
                }
				// 產生欄位(種類: 單一)
				var createField = function(fieldObj){                   
                    // 1. 欄位定義初始化    
                    
                    //   初始[id]
                    var thisID = 'id' + fieldObj.id;

                    var divObj = $("<div id='" + thisID + "' class='fvField fv-opacity'></div>");

                    //   初始[fname]
                    $(divObj).append(fieldObj.fname);

                    //   初始[flocation: left,top,subitems,interval]
                    var fLeft = fieldObj.flocation.split(",")[0];
                    var fTop = fieldObj.flocation.split(",")[1];
                    if(!fTop){
                    	fTop = (parseInt(fieldObj.id) -1) * 35;  // Todo: Lib parament: (35) 預設 element 之間的間距
                    	fLeft = 0;
                    }
                    else{
                    	fLeft = parseInt(fLeft);
                        fTop = parseInt(fTop);
                    }

	                divObj.css("left", fLeft);                      
	                divObj.css("top", fTop);  

					if(fieldObj.ftype=='多重'){
						var fsubitems = fieldObj.flocation.split(",")[2];
						var ftopinterval = fieldObj.flocation.split(",")[3];                        
		                // Todo: Lib parament: (30) 預設 subitem 之間的間距 
		                if(!fsubitems){
		                	divObj.data("topInterval",30);
		                }
		                else{
		                	divObj.data("topInterval",fsubitems);	
		                }
		                // Todo: Lib parament: (0) 預設 subitem 的個數
		                if(!ftopinterval){
		                	divObj.data("nextSubItems",0); 	
		                }
		                else{
		                	divObj.data("nextSubItems",ftopinterval);
		                }
					}

                    //   初始[ftalign] 
                    var ftalign =  fieldObj.ftalign;
					if(!ftalign){
	                	divObj.data("ftalign", '置左');  // Todo: Lib parament: ('置左') 預設 文字對齊方式 置左/置中/置右
                    }
                    else{
                    	divObj.data("ftalign", ftalign);	
                    } 

                    //   初始[fwidth]
					var fwidth = fieldObj.fwidth;
					if(!fwidth){
	                	divObj.css("width", 140);  // Todo: Lib parament: (140) 預設 欄位寬度
                    }
                    else{
                    	divObj.css("width", parseInt(fwidth));	
                    }

                    // 欄位設定功能
                    var configSpan = $('<span style="float:left;margin-left:5px" class="fvfConfig ui-icon"></span>');

                    configSpan.addClass(configClosed);	

                    $(divObj).append(configSpan);
					

					$('#formArea').append(divObj);

                    // 2. 欄位拖曳處理
				    $("#" + thisID).draggable({
				    	containment: '#formArea', 
						scroll: false,

				        start: function(ev, ui) {
				        	ev.stopPropagation();
				            $(this).is(".ui-selected") || $(".ui-selected").removeClass("ui-selected");
				           
				            selected = $(".ui-selected").each(function() {
				                var el = $(this);
				                el.data("offset", el.offset());
				            });

				            $('div[id*="'+thisID+'_"]').each(function() {				            	
				                var el = $(this);
				                el.data("offset", el.offset());				                				                
				            });	
				            offset = $(this).offset();
				        },
				        drag: function(ev, ui) {
				        	ev.stopPropagation();
				            var dt = ui.position.top - offset.top, dl = ui.position.left - offset.left;
				            selected.not(this).each(function() {
				                var el = $(this), off = el.data("offset");
				                el.css({top: off.top + dt, left: off.left + dl});				                
				            });

				            $('div[id*="'+thisID+'_"]').each(function() {				            	
				                var el = $(this), off = el.data("offset");
				                el.css({top: off.top + dt, left: off.left + dl});				                
				            });	
				            // Prevent button inside div to be triggered
				            $(this).data('isDragging', true);			            				            
				        },
				        stop: function(ev, ui){	
				        	ev.stopPropagation();	        	
				        }
				    }).mousemove(function(e){
						var coord = $(this).position();
						$("div#status").text( "left: " + coord.left + ", top: " + coord.top );
					}).mouseup(function(e){
						var coords=[];
						var coord = $(this).position();
						var item={ coordTop:  coord.left, coordLeft: coord.top  };
					   	coords.push(item);
					}).resizable({
					    handles: 'e, w',
			            maxWidth: 500,
			            minWidth: 100,
			            resize: function(event, ui) {
			            	var fWidth = $(this).css('width');
			       			$('div[id*="'+thisID+'_"]').each(function() {				            	
				                var el = $(this);
				                el.css('width', fWidth);				                
				            });	
			            }
					});

                    // 3. 單擊選擇
                    $('#' + thisID).click(function(e){
                    	// click through the div to span (click the span icon)
					    if ($(e.target).is("span")) return;
					    if ($(e.target).is("button")) return;
	                    e.stopPropagation();

	                    if($(this).is(".ui-selected")){
	                    	$(this).removeClass('ui-selected');
	                    }
	                    else{
	                    	$(this).addClass('ui-selected');	
	                    }
					});

					// 4. 欄位設定按鈕
	                $('#' + thisID + ' span.fvfConfig').click(function (e){
	                	// Prevent button inside div to be triggered	                	
		                if($(this).hasClass(configClosed)) {
		                	$(this).removeClass(configClosed).addClass(configOpened);
		                	//$(this).addClass('configuring');

                            // 展開設定面板
		                    var configDiv = $('<div class="config"></div>');
		                    configDiv.addClass('configuring');

							var fSLabel = $('<label>欄位長度</label>');
							var fSInput = $('<input class="fvfcWidth" type="text" size="3" maxlength="3">');
							fSInput.val(parseInt($('#' + thisID).css('width')));
							configDiv.append(fSLabel);
							configDiv.append(fSInput);
							configDiv.append('px<br/>');

							var fWALabel = $('<label>對齊方式</label>');
							configDiv.append(fWALabel);
							var fWASelect = $('<select class="fvfcTAlign"><option value="置左">置左</option><option value="置中">置中</option><option value="置右">置右</option></select><br/>');
							fWASelect.val($(this).parent().data('ftalign'));
							configDiv.append(fWASelect);

							configDiv.append($('<hr>'));

							var fButtonSpan = $('<span align="right"></span>');							
							var fOKButton = $('<button>確定</button>');
							var fCancelButton = $('<button>離開</button>');
							fCancelButton.bind('click', function() {
								$(this).closest(".config").siblings(".fvfConfig").click();
							});
							fOKButton.bind('click', function() {
							    // Apply [欄位長度]							
								$(this).closest('.fvField').css('width', $(this).closest(".config").children('.fvfcWidth').val());
								// Apply [文字對齊方式]
								$(this).closest('.fvField').data('ftalign', $(this).closest(".config").children('.fvfcTAlign').val());
							});
							fButtonSpan.append(fOKButton);
							fButtonSpan.append(fCancelButton);
							configDiv.append(fButtonSpan);

		                    $(this).closest('.fvField').append(configDiv);

		                    $('.fvField').not($(this).closest('#' + thisID)).css('z-index', 100);
		                    $(this).closest('.fvField').css('z-index', 10000);
		                    $(this).closest('.fvField').removeClass('fv-opacity');
	                	}
	                	else{
							$(this).removeClass(configOpened).addClass(configClosed);
                            
                            // 關閉設定面板
							$('#' + thisID + ' div.config').remove();
							$(this).closest('#' + thisID).css('z-index', 100);
							$(this).closest('#' + thisID).addClass('fv-opacity');
	                	}                        
	                });

					if(fieldObj.ftype=='多重'){
	                    var plusSpan = $('<span style="float:right;margin-left:8px" class="ui-icon"></span>');
	                    plusSpan.addClass(columnPlus);
	                    var minusSpn = $('<span style="float:right;margin-left:5px" class="ui-icon"></span>');
	                    minusSpn.addClass(columnMinus);
						$(divObj).append(plusSpan);
					    $(divObj).append(minusSpn);
                        //alert(fieldObj.ftype=='多重'); 

		                // 5. 多重欄位增加按鈕(+)
		                $('#' + thisID + ' span.' + columnPlus).click(function (e){	
		                	// Prevent button inside div to be triggered (Todo: refactory)
							if($(this).closest('#' + thisID).data("isDragging")){
								$(this).closest('#' + thisID).removeData("isDragging");
								return
							}
							e.stopPropagation();
							
							var nextSubItems = parseInt($('#' + thisID).data("nextSubItems"));
	                        
							// if(!nextSubItems){
							// 	nextSubItems = 1;
							// 	//alert(nextSubItems);
							// }
							// else{
							nextSubItems++;	
							//}	                        
                       
	                        var divLeft = parseInt($(this).closest('.fvField').css('left'));
	                        var divTop = parseInt($(this).closest('.fvField').css('top'));	                        
	                        var topInterval = parseInt($(this).closest('.fvField').data("topInterval"));

	 						var divObj = $("<div id='" + thisID + '_' + nextSubItems + "' style='left:" + divLeft + "px;top:" + (divTop+nextSubItems*topInterval) + "px;' class='fvSubField'></div>");

                            divObj.css('width', $(this).closest('.fvField').css('width'));

							$('#formArea').append(divObj);
							$(this).closest('.fvField').data("nextSubItems", nextSubItems);

	 						if(nextSubItems==1){
	 							divObj.draggable({
	 							    axis: "y",
	 							    drag: function(ev, ui) {
	 							    	ev.stopPropagation();
	                                    var subTop = parseInt($('#'+thisID+'_1').css('top').replace("px", ""));
	                                    var topInterval = subTop - divTop;
	                                    $(this).closest('.fvField').data("topInterval", topInterval);
	                                    //alert(invTop);
	 							    	$('div[id*="'+thisID+'_"]').not(this).each(function() {
					                		var el = $(this);
					                		var theID = parseInt(el.attr('id').split("_")[1]);
					                		//alert(theID);
					                		el.css({top: divTop + theID * topInterval});				                
					            		});	
	 							    },
	 								stop: function(ev, ui){	
			                            ev.stopPropagation();
				        			}
	 							});
	 						}	                        
							//alert('plus');						
		                });
		                // 6. 多重欄位減少按鈕(-)
		                $('#' + thisID + ' span.' + columnMinus).click(function (e){		                	
		                	// Prevent button inside div to be triggered (Todo: refactory)
							if($(this).closest('#' + thisID).data("isDragging")){
								$(this).closest('#' + thisID).removeData("isDragging");
								return
							}
							e.stopPropagation();

							var nextSubItems = parseInt($('#' + thisID).data("nextSubItems"));
							
							if(!nextSubItems){
								$('#' + thisID).data("topInterval", 30); //預設 subitem 之間的間距 
								return;
							};
							//alert(nextSubItems);
							$('#' + thisID + '_' + nextSubItems).remove();
							$('#' + thisID).data("nextSubItems", nextSubItems -1);

							//alert('minus');						
		                });
	            	}
				};

                $("button").button();

				// 處理[初始定位]
				var initLocation = function(fields){
			        for(var i = 0; i < fields.length; i++){
			            createField(fields[i]);	
			        }
					//alert('initLocation');
				};
                $("#initButton").click(
                	function(){
	                	initLocation(fields);
                	}
                );
                
                // 處理[清除定位]
                $("#cleanButton").click(
                	function(){
                        $("#formArea div").remove();
                	}
                );

				// 處理[完成定位]				    
                $("#finishButton").click(function(){
					$("#list").jqGrid("clearGridData", true);
					for(var i=0;i<fields.length;i++){
	                    var theLeft = parseInt($('#id'+ (i+1)).css('left'));
	                    var theTop = parseInt($('#id'+ (i+1)).css('top'));
	                    var nextSubItems = $('#id'+ (i+1)).data('nextSubItems');
	                    var topInterval = $('#id'+ (i+1)).data('topInterval');
	                    if(fields[i].ftype=='多重'){
	                    	fields[i].flocation = theLeft + ',' + theTop + ',' + nextSubItems + ',' + topInterval;
	                    }
	                    else{
	                    	fields[i].flocation = theLeft + ',' + theTop;
	                    }
                        
                        fields[i].fwidth = parseInt($('#id'+ (i+1)).css('width'));
                        fields[i].ftalign = $('#id'+ (i+1)).data('ftalign');

						$('#list').jqGrid('addRowData',i+1,fields[i]);
					}
                    $('#list').trigger("reloadGrid");

				    try {
				        localStorage.setItem('FormViewer.fields', JSON.stringify(fields));
				    }
				    catch (err) {
				    	console.log("fail to call localStorage.setItem()");
	                }
                    
					console.log(JSON.stringify(fields));
                });

				// 處理[報表預覽]	
				$("#previewButton").click(function(){					
					//fkey:"fsign"
					//fkey:"fproduct"
					//fkey:"fsummary"
					//fkey:"fcost"
					//fkey:"ffcur"
					//fkey:"fexrate"
					//fkey:"frcur"
					//fkey:"facc"
					//fkey:"ftotal"

					var data = {}; // New object
					data['fsign'] = '簡經理';
					data['fproduct'] = ['100學年度 學費', '100學年度 住宿費'];
					data['fsummary'] = ['代墊', '誠齋(男生宿舍)'];
					data['fcost'] = [15000, 8000];
					data['ffcur'] = '台幣';
					data['fexrate'] = '1:33.33';
					data['frcur'] = '美金';
					data['ftotal'] = 23000;

					//alert(data['fproduct'][1]);
					var cc = '';
					for(var key in data){
    					cc += key+' : '+data[key]+'<br />';
					}
					alert(cc);
				});

			    $("#formArea").selectable({
			    	filter: ':not(".fvSubField")'
			    });

                // 欄位方向鍵微調
				$("body").keydown(function(e) {
					if(e.keyCode == 37) { // left
					    selected = $(".ui-selected").each(function() {
					        var el = $(this);
					        el.css({left: parseInt($(this).css('left').replace("px", "")) - 1});					        
					    });
					}
					else if(e.keyCode == 39) { // right						
					    selected = $(".ui-selected").each(function() {
					        var el = $(this);					        
					        el.css({left: parseInt($(this).css('left').replace("px", "")) + 1});    
					    });
					}
					else if(e.keyCode == 38) { // up
					    selected = $(".ui-selected").each(function() {
					        var el= $(this);
					        el.css({top: parseInt($(this).css('top').replace("px", "")) - 1});
					    });
					}
					else if(e.keyCode == 40) { // down
					    selected = $(".ui-selected").each(function() {
					        var el= $(this);
					        el.css({top: parseInt($(this).css('top').replace("px", "")) + 1});
					    });
					}

				}).keyup(function(e) {
					if(e.keyCode == 27) { // ESC
					    selected = $(".ui-selected").each(function() {
					        var el= $(this);
					        el.removeClass("ui-selected");
					    });					
					}	
				});

		        $("#list").jqGrid({
					//url:'example.json',
					datatype: 'local',
					mtype: 'GET',
					colNames:['名稱', '種類', '位置', '欄寬', '對齊'],
					colModel :[ 
						{name:'fname', index:'fname', width:120}, 
						{name:'ftype', index:'ftype', width:50, align:'center'}, 
						{name:'flocation', index:'flocation', width:100, align:'left'}, 
						{name:'fwidth', index:'fwidth', width:50, align:'left'},
						{name:'ftalign', index:'ftalign', width:50, align:'center'}
					],
					onSelectRow: function(id){
						selected = $(".ui-selected").each(function() {
					    	var el= $(this);
					    	el.removeClass("ui-selected");
						});		
						$('#id' + id).click();
					},
					height: 500,
					sortname: 'invid',
					sortorder: 'desc',
					viewrecords: true,
					gridview: true,
					caption: '欄位定位'
		        }); 

		        for(var i=0;i<=fields.length;i++){
		        	$('#list').jqGrid('addRowData',i+1,fields[i]);
		        }

			});
		</script>
	</body>
</html>


